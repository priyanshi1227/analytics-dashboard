{% extends "base.html" %}

{% block title %}Funnel Analysis - AI Analytics{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Funnel Analysis</h1>
        <p class="text-gray-600 dark:text-gray-400">Track user conversion through key journey stages</p>
    </div>

    <!-- Controls -->
    <div class="card p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Funnel Type</label>
                <select id="funnelType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                    <option value="onboarding">User Onboarding</option>
                    <option value="purchase">Purchase Flow</option>
                    <option value="signup">Signup Process</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date Range</label>
                <select id="dateRange" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Segment</label>
                <select id="userSegment" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                    <option value="all">All Users</option>
                    <option value="new">New Users</option>
                    <option value="returning">Returning Users</option>
                </select>
            </div>
            <div class="flex items-end">
                <button id="analyzeFunnel" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
                    <i class="fas fa-filter mr-2"></i>Analyze
                </button>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div id="funnelResults">
        <div class="card p-12 text-center">
            <i class="fas fa-filter text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">No Data Yet</h3>
            <p class="text-gray-500 dark:text-gray-400">Configure your analysis and click "Analyze" to see funnel data</p>
        </div>
    </div>

    <!-- Loading State -->
    <div id="funnelLoading" class="hidden text-center py-12">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-gray-600 dark:text-gray-400">Analyzing funnel data...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const analyzeButton = document.getElementById('analyzeFunnel');
        if (analyzeButton) {
            analyzeButton.addEventListener('click', analyzeFunnel);
        }
        // Auto-run on load
        setTimeout(analyzeFunnel, 500);
    });

    function analyzeFunnel() {
        const funnelType = document.getElementById('funnelType').value;
        const dateRange = document.getElementById('dateRange').value;
        const userSegment = document.getElementById('userSegment').value;

        const loadingElement = document.getElementById('funnelLoading');
        const resultsElement = document.getElementById('funnelResults');

        // Show loading
        loadingElement.classList.remove('hidden');
        resultsElement.innerHTML = '';

        // Simulate processing
        setTimeout(() => {
            try {
                const data = generateFunnelData(funnelType, dateRange, userSegment);
                renderFunnelResults(data);
                if (window.toast) {
                    window.toast.show('Funnel analysis completed!', 'success');
                }
            } catch (error) {
                console.error('Error:', error);
                if (window.toast) {
                    window.toast.show('Analysis failed', 'error');
                }
                showError();
            } finally {
                loadingElement.classList.add('hidden');
            }
        }, 1000);
    }

    function renderFunnelResults(data) {
        const container = document.getElementById('funnelResults');

        const stages = data.funnel_stages;
        const totalUsers = stages[0].users;

        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="card p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600">${data.metrics.total_conversion}%</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Overall Conversion</div>
                </div>
                <div class="card p-4 text-center">
                    <div class="text-2xl font-bold text-green-600">${totalUsers.toLocaleString()}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Total Users</div>
                </div>
                <div class="card p-4 text-center">
                    <div class="text-2xl font-bold text-purple-600">${data.metrics.dropoff_rate}%</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Drop-off Rate</div>
                </div>
                <div class="card p-4 text-center">
                    <div class="text-2xl font-bold text-orange-600">${stages[stages.length - 1].users.toLocaleString()}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Completed</div>
                </div>
            </div>

            <!-- Visual Funnel -->
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Funnel Visualization</h3>
                <div class="funnel-container">
                    ${stages.map((stage, index) => {
                        const percentage = Math.round((stage.users / totalUsers) * 100);
                        const width = 100 - (index * 15); // Decreasing width for funnel effect
                        const dropoff = index > 0 ? stages[index - 1].users - stage.users : 0;
                        const dropoffPercentage = index > 0 ? Math.round((dropoff / stages[index - 1].users) * 100) : 0;

                        return `
                            <div class="funnel-stage relative mb-2">
                                ${index > 0 ? `
                                    <div class="dropoff-indicator absolute -top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white text-xs px-2 py-1 rounded">
                                        -${dropoff.toLocaleString()} (${dropoffPercentage}%)
                                    </div>
                                ` : ''}
                                <div class="funnel-bar bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg p-4 text-white transition-all duration-500 ease-in-out"
                                     style="width: ${width}%">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center font-bold">
                                                ${index + 1}
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-white">${stage.name}</h4>
                                                <p class="text-blue-100 text-sm">${stage.description}</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xl font-bold">${stage.users.toLocaleString()}</div>
                                            <div class="text-blue-100 text-sm">${percentage}% of total</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <!-- Stage Details -->
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Stage Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-${stages.length} gap-4">
                    ${stages.map((stage, index) => {
                        const percentage = Math.round((stage.users / totalUsers) * 100);
                        const dropoff = index > 0 ? stages[index - 1].users - stage.users : 0;
                        const dropoffPercentage = index > 0 ? Math.round((dropoff / stages[index - 1].users) * 100) : 0;

                        return `
                            <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                <div class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg mx-auto mb-3">
                                    ${index + 1}
                                </div>
                                <h4 class="font-semibold text-gray-900 dark:text-white mb-2">${stage.name}</h4>
                                <div class="text-2xl font-bold text-blue-600 mb-1">${stage.users.toLocaleString()}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">${percentage}% of total</div>
                                ${index > 0 ? `
                                    <div class="text-xs text-red-500 bg-red-50 dark:bg-red-900/20 px-2 py-1 rounded">
                                        ${dropoffPercentage}% drop-off
                                    </div>
                                ` : '<div class="text-xs text-green-500 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded">Starting point</div>'}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <!-- Progress Bars -->
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Conversion Progress</h3>
                <div class="space-y-4">
                    ${stages.map((stage, index) => {
                        const percentage = Math.round((stage.users / totalUsers) * 100);
                        const color = index === 0 ? 'bg-green-500' :
                                     index === stages.length - 1 ? 'bg-purple-500' : 'bg-blue-500';

                        return `
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="font-medium text-gray-700 dark:text-gray-300">${stage.name}</span>
                                    <span class="text-gray-600 dark:text-gray-400">${stage.users.toLocaleString()} users (${percentage}%)</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                    <div class="${color} h-3 rounded-full transition-all duration-1000 ease-out"
                                         style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <!-- Insights -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Optimization Insights</h3>
                <div class="space-y-3">
                    <div class="flex items-start space-x-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                        <i class="fas fa-lightbulb text-yellow-500 mt-1"></i>
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white">Conversion Opportunity</h4>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">Overall conversion rate is ${data.metrics.total_conversion}%. Focus on improving stages with high drop-off.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <i class="fas fa-chart-line text-blue-500 mt-1"></i>
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white">Strong Start</h4>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">Good initial engagement with ${totalUsers.toLocaleString()} users starting the funnel.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                        <i class="fas fa-bullseye text-green-500 mt-1"></i>
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white">Retention Focus</h4>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">${stages[stages.length - 1].users.toLocaleString()} users completed the entire journey.</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Animate the progress bars after rendering
        setTimeout(() => {
            document.querySelectorAll('.funnel-bar').forEach((bar, index) => {
                bar.style.animationDelay = `${index * 200}ms`;
                bar.classList.add('animate-funnel');
            });
        }, 100);
    }

    function showError() {
        const container = document.getElementById('funnelResults');
        container.innerHTML = `
            <div class="card p-6 text-center">
                <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Analysis Error</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Please try again</p>
                <button onclick="analyzeFunnel()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
                    Retry Analysis
                </button>
            </div>
        `;
    }

    function generateFunnelData(funnelType, dateRange, userSegment) {
        // Simple funnel configurations
        const funnels = {
            onboarding: [
                { name: "Visited Site", description: "User landed on homepage" },
                { name: "Signed Up", description: "Created an account" },
                { name: "Onboarding", description: "Started onboarding" },
                { name: "First Action", description: "Completed first action" }
            ],
            purchase: [
                { name: "Product View", description: "Viewed product" },
                { name: "Add to Cart", description: "Added to cart" },
                { name: "Checkout", description: "Started checkout" },
                { name: "Purchase", description: "Completed purchase" }
            ],
            signup: [
                { name: "Landing Page", description: "Visited signup page" },
                { name: "Form Start", description: "Started form" },
                { name: "Form Complete", description: "Completed form" },
                { name: "Verified", description: "Email verified" }
            ]
        };

        const stagesConfig = funnels[funnelType] || funnels.onboarding;

        // Base users based on date range
        const baseUsers = { '7': 5000, '30': 15000, '90': 45000 }[dateRange] || 15000;

        // Adjust for user segment
        const multipliers = { 'all': 1, 'new': 0.7, 'returning': 0.3 };
        const totalUsers = Math.round(baseUsers * (multipliers[userSegment] || 1));

        // Generate stage data with realistic drop-offs
        const stages = [];
        let currentUsers = totalUsers;

        for (let i = 0; i < stagesConfig.length; i++) {
            if (i > 0) {
                // Apply drop-off (20-40% between stages)
                const dropoffRate = 0.2 + (Math.random() * 0.2);
                currentUsers = Math.round(currentUsers * (1 - dropoffRate));
            }
            stages.push({
                ...stagesConfig[i],
                users: currentUsers
            });
        }

        // Calculate metrics
        const totalConversion = Math.round((stages[stages.length - 1].users / totalUsers) * 100);
        const totalDropoff = totalUsers - stages[stages.length - 1].users;
        const dropoffRate = Math.round((totalDropoff / totalUsers) * 100);

        return {
            funnel_stages: stages,
            metrics: {
                total_conversion: totalConversion,
                dropoff_rate: dropoffRate,
                total_users: totalUsers
            }
        };
    }
</script>

<style>
.loading-spinner {
    border: 3px solid #f3f4f6;
    border-top: 3px solid #3b82f6;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}

.dark .card {
    background: #1f2937;
}

/* Funnel Visualization Styles */
.funnel-container {
    max-width: 800px;
    margin: 0 auto;
}

.funnel-stage {
    transition: all 0.3s ease;
}

.funnel-bar {
    margin: 0 auto;
    position: relative;
    overflow: hidden;
}

.funnel-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
}

.funnel-bar:hover::before {
    left: 100%;
}

.animate-funnel {
    animation: slideIn 0.8s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-50px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.dropoff-indicator {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: translateX(-50%) scale(1); }
    50% { transform: translateX(-50%) scale(1.05); }
}

/* Progress bar animations */
.h-3 {
    transition: width 1s ease-in-out;
}
</style>
{% endblock %}